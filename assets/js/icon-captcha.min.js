/**
 * IconCaptcha Plugin: v3.0.0
 * Copyright Â© 2021, Fabian Wennink (https://www.fabianwennink.nl)
 *
 * Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 */
"use strict";(function(a){a.fn.extend({iconCaptcha:function(b){var c=a.extend(!0,{theme:[""],fontFamily:"",clickDelay:1e3,invalidResetDelay:3e3,hoverDetection:!0,showCredits:"show",enableLoadingAnimation:!1,loadingAnimationDelay:2e3,requestIconsDelay:1500,validationPath:"",invalidateTime:300000,messages:{initialization:{loading:"Loading challenge...",verify:"Verify that you are human."},header:"Select the icon displayed the least amount of times",correct:{top:"Great!",bottom:"You do not appear to be a robot."},incorrect:{top:"Oops!",bottom:"You've selected the wrong image."}}},b),d="https://www.fabianwennink.nl/projects/IconCaptcha",e="IconCaptcha by Fabian Wennink";return this.each(function(b){var f=Math.round;function g(a){var b=B.data("theme")||"light";return B.addClass("iconcaptcha-theme-"+b),c.fontFamily&&B.css("font-family",c.fontFamily),D?void(!H&&j(),!a&&o(),h(b,a),C=!0):void i()}function h(d){var e=u({i:A,a:1,t:d});a.ajax({url:c.validationPath,type:"post",data:{payload:e},success:function(a){if(a&&"string"==typeof a){var d=JSON.parse(atob(a));d.icons;var e=u({i:A}),f=w.find(".iconcaptcha-modal__body-icons");f.css("background-image","url(".concat(c.validationPath,"?payload=").concat(e,")")),q(f,w),f.parent().append("<div class=\"iconcaptcha-modal__body-selection\"><i></i></div>"),z=w.find(".iconcaptcha-modal__body-selection > i"),H||B.trigger("init",[{captcha_id:b}]);var g=w.find(".iconcaptcha-modal__body-selection");return F=g.width(),G=g.height(),I=new Date,H=!0,void(E=setTimeout(function(){return r()},c.invalidateTime))}t(!0,"The IconCaptcha could not be loaded.","Invalid data was returned by the captcha back-end service. Make sure IconCaptcha is installed/configured properly.")},error:n})}function i(){var a=["<div class='iconcaptcha-modal'>","<div class='iconcaptcha-modal__body'>","<div class='iconcaptcha-modal__body-circle'></div>","<div class='iconcaptcha-modal__body-info'>","<a href='".concat(d,"' target='_blank' rel='follow' title='").concat(e,"'>IconCaptcha &copy;</a>"),"</div>","<div class='iconcaptcha-modal__body-title'>".concat(c.messages.initialization.verify,"</div>"),"</div>","</div>"];B.addClass("iconcaptcha-init"),B.html(a.join(""))}function j(){var a=["<div class='iconcaptcha-modal'>","<div class='iconcaptcha-modal__header'>","<span>".concat(c.messages.header,"</span>"),"</div>","<div class='iconcaptcha-modal__body'>","<div class='iconcaptcha-modal__body-icons'></div>","</div>","<div class='iconcaptcha-modal__footer'>"];if("show"===c.showCredits||"hide"===c.showCredits){var b="hide"===c.showCredits?"display: none":"";a.push("<span style='".concat(b,"'><a href='").concat(d,"' target='_blank' rel='follow' title='").concat(e,"'>IconCaptcha</a> &copy;</span>"))}a.push("</div>","<div class='iconcaptcha-modal__fields'>","<input type='hidden' name='ic-hf-se' required />","<input type='hidden' name='ic-hf-id' value='".concat(A,"' required />"),"<input type='hidden' name='ic-hf-hp' required />","</div>"),a.push("</div>"),B.html(a.join("")),w=B.find(".iconcaptcha-modal__body")}function k(){B.removeClass("iconcaptcha-error"),B.find("input[name='ic-hf-se']").attr("value",null),w.empty(),w.append("<div class='iconcaptcha-modal__body-icons'></div>"),g(!0),B.trigger("refreshed",[{captcha_id:A}])}function l(b,d){if(b!==void 0&&d!==void 0){J=!0,s(),b=f(b),d=f(d),B.find("input[name=\"ic-hf-se\"]").attr("value",[b,d,F].join(",")),B.find("input[name=\"ic-hf-id\"]").attr("value",A),z.hide();var e=u({i:A,x:b,y:d,w:F,a:2});a.ajax({url:c.validationPath,type:"POST",data:{payload:e},success:m,error:n})}}function m(){B.find(".iconcaptcha-modal__header").remove(),B.addClass("iconcaptcha-success"),w.removeClass("captcha-opacity"),w.html("<div class=\"iconcaptcha-modal__body-title\">".concat(c.messages.correct.top,"</div>")+"<div class=\"iconcaptcha-modal__body-subtitle\">".concat(c.messages.correct.bottom,"</div>")),J=!1,B.trigger("success",[{captcha_id:A}])}function n(){B.addClass("iconcaptcha-error"),w.removeClass("captcha-opacity"),w.html("<div class=\"iconcaptcha-modal__body-title\">"+(c.messages.incorrect&&c.messages.incorrect.top?c.messages.incorrect.top:"Oops!")+"</div><div class=\"iconcaptcha-modal__body-subtitle\">"+(c.messages.incorrect&&c.messages.incorrect.bottom?c.messages.incorrect.bottom:"You've selected the wrong image.")+"</div>"),J=!1,B.trigger("error",[{captcha_id:A}]),setTimeout(k,c.invalidResetDelay)}function o(){w.addClass("captcha-opacity"),w.prepend("<div class=\"captcha-loader\"></div>")}function p(){w.removeClass("captcha-opacity"),w.find(".captcha-loader").remove()}function q(a){var b=a.css("background-image").match(/\((.*?)\)/)[1].replace(/('|")/g,""),c=new Image;c.onload=function(){return p(w)},c.src=b,c.complete&&c.onload(this)}function r(){H=!1,D=!1;var b=u({i:A,a:3});a.ajax({url:c.validationPath,type:"post",data:{payload:b},success:i,error:n})}function s(){null!==E&&(clearTimeout(E),E=null)}function t(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:"";B.html("IconCaptcha Error: "+b),console.error("IconCaptcha Error: "+(""!==c)?c:b),a&&B.trigger("error",[{captcha_id:A}])}function u(a){return btoa(JSON.stringify(a))}function v(b){var c=f(b.pageX-a(b.currentTarget).offset().left),d=f(b.pageY-a(b.currentTarget).offset().top);z.css({left:c-8+"px",top:d-7+"px"})}var w,z,A=b+1,B=a(this),C=!1,D=!1,E=null,F=0,G=0,H=!1,I=0,J=!1,K=!1;return c.validationPath?void(g(!1),B.on("click",function(a){D||a.target instanceof HTMLAnchorElement||(B.find(".iconcaptcha-modal__body-circle").css("animation-duration","2s"),B.find(".iconcaptcha-modal__body-title").text(c.messages.initialization.loading),setTimeout(function(){D=!0,B.removeClass("iconcaptcha-init"),g(!0)},500))}),B.on("click",".iconcaptcha-modal__body-selection",function(b){if(!(new Date-I<=c.clickDelay)&&(!c.hoverDetection||K)){var d=b.pageX-a(b.currentTarget).offset().left,e=b.pageY-a(b.currentTarget).offset().top;d&&e&&!w.hasClass("captcha-opacity")&&(B.trigger("selected",[{captcha_id:A}]),!0===c.enableLoadingAnimation?(o(),setTimeout(function(){return l(d,e)},c.loadingAnimationDelay)):l(d,e))}}),B.on("mousemove",".iconcaptcha-modal__body-selection",function(a){C&&K&&!J&&H&&v(a)}).on("mouseenter",".iconcaptcha-modal__body-selection",function(a){z.show(),v(a),K=!0}).on("mouseleave",".iconcaptcha-modal__body-selection",function(){z.hide(),K=!1})):void t(!0,"The IconCaptcha was configured incorrectly.","The option `validationPath` has not been set.")})}})})(jQuery);